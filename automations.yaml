- id: slaapkamer_wall_switch_click
  alias: Slaapkamer lamp toggle
  trigger:
    platform: mqtt
    topic: 'zigbee2mqtt/slaapkamer_wall_switch'
  condition:
    condition: template
    value_template: '{{ "single" == trigger.payload_json.click }}'
  action:
    service: light.toggle
    entity_id: light.slaapkamer_light

- id: slaapkamer_switch_toggle
  alias: Slaapkamer lamp toggle
  trigger:
    platform: mqtt
    topic: 'zigbee2mqtt/ikea_four_button_switch'
  condition:
    condition: template
    value_template: '{{ "toggle" == trigger.payload_json.action }}'
  action:
    service: light.toggle
    entity_id: light.slaapkamer_light

- id: slaapkamer_switch_dim_lower
  alias: Slaapkamer lamp dim lower
  trigger:
    platform: mqtt
    topic: 'zigbee2mqtt/ikea_four_button_switch'
  condition:
    condition: template
    value_template: '{{ "brightness_down_click" == trigger.payload_json.action }}'
  action:
    service: light.turn_on
    entity_id: light.slaapkamer_light
    data_template:
      brightness: '{{ states.light.slaapkamer_light.attributes.brightness | int - 25 | int }}'

- id: slaapkamer_switch_dim_up
  alias: Slaapkamer dim up
  trigger:
    platform: mqtt
    topic: 'zigbee2mqtt/ikea_four_button_switch'
  condition:
    condition: template
    value_template: '{{ "brightness_up_click" == trigger.payload_json.action }}'
  action:
    service: light.turn_on
    entity_id: light.slaapkamer_light
    data_template:
      brightness: '{{ states.light.slaapkamer_light.attributes.brightness | int + 25 | int }}'

- id: slaapkamer_switch_default_color
  alias: Slaapkamer lamp default kleur
  trigger:
    platform: mqtt
    topic: 'zigbee2mqtt/ikea_four_button_switch'
  condition:
    condition: template
    value_template: '{{ "arrow_left_click" == trigger.payload_json.action }}'
  action:
    service: light.turn_on
    entity_id: light.slaapkamer_light
    data:
      rgb_color: [255,200,118]

- id: slaapkamer_switch_red
  alias: Slaapkamer lamp maak rood
  trigger:
    platform: mqtt
    topic: 'zigbee2mqtt/ikea_four_button_switch'
  condition:
    condition: template
    value_template: '{{ "arrow_right_click" == trigger.payload_json.action }}'
  action:
    service: light.turn_on
    entity_id: light.slaapkamer_light
    data:
      rgb_color: [255,39,39]

- id: cube_dim_lower
  alias: Cube dim lower
  trigger:
    platform: mqtt
    topic: 'zigbee2mqtt/cube'
  condition:
    condition: template
    value_template: '{{ "rotate_left" == trigger.payload_json.action }}'
  action:
    service: light.turn_on
    data:
      entity_id:
        - light.ikea_lamp_1_light
        - light.ikea_lamp_2_light
        - light.ikea_lamp_3_light
    data_template:
      brightness: '{{ states.light.ikea_lamp_1_light.attributes.brightness | int - 25 | int }}'

- id: cube_dim_upper
  alias: Cube dim upper
  trigger:
    platform: mqtt
    topic: 'zigbee2mqtt/cube'
  condition:
    condition: template
    value_template: '{{ "rotate_right" == trigger.payload_json.action }}'
  action:
    service: light.turn_on
    data:
      entity_id:
        - light.ikea_lamp_1_light
        - light.ikea_lamp_2_light
        - light.ikea_lamp_3_light
    data_template:
      brightness: '{{ states.light.ikea_lamp_1_light.attributes.brightness | int +25 | int }}'

- id: toggle_woonkamer_lights
  alias: Toggle woonkamer lights
  trigger:
    platform: mqtt
    topic: 'zigbee2mqtt/cube'
  condition:
    condition: template
    value_template: '{{ "shake" == trigger.payload_json.action }}'
  action:
    entity_id: group.woonkamer_lights
    service: homeassistant.toggle

- id: enable_zigbee_join
  alias: Enable Zigbee joining
  hide_entity: true
  trigger:
    platform: state
    entity_id: input_boolean.zigbee_permit_join
    to: 'on'
  action:
  - service: mqtt.publish
    data:
      topic: zigbee2mqtt/bridge/config/permit_join
      payload: 'true'
  - service: timer.start
    data:
      entity_id: timer.zigbee_permit_join
- id: disable_zigbee_join
  alias: Disable Zigbee joining
  trigger:
  - entity_id: input_boolean.zigbee_permit_join
    platform: state
    to: 'off'
  action:
  - data:
      payload: 'false'
      topic: zigbee2mqtt/bridge/config/permit_join
    service: mqtt.publish
  - data:
      entity_id: timer.zigbee_permit_join
    service: timer.cancel
  hide_entity: true
- id: disable_zigbee_join_timer
  alias: Disable Zigbee joining by timer
  hide_entity: true
  trigger:
  - platform: event
    event_type: timer.finished
    event_data:
      entity_id: timer.zigbee_permit_join
  action:
  - service: mqtt.publish
    data:
      topic: zigbee2mqtt/bridge/config/permit_join
      payload: 'false'
  - service: input_boolean.turn_off
    data:
      entity_id: input_boolean.zigbee_permit_join

# Doe de lichten aan bij het openen van het slot als de lampen in het afgelopen uur niet aan- of uitgezet zijn
- id: licht_aan_bij_thuiskomst
  alias: Licht aan bij thuiskomst
  hide_entity: true
  trigger:
    - platform: state
      entity_id: binary_sensor.deur
      from: 'on'
      to: 'off'
  condition:
    condition: and
    conditions:
    - condition: sun
      after: sunset
    - condition: time
      before: '21:00'
    - condition: template
      value_template: '{{ (as_timestamp(strptime(states.sensor.date_time.state, "%Y-%m-%d, %H:%M")) - as_timestamp(states.group.woonkamer_lights.last_changed)) > 3600 }}'
  action:
    service: homeassistant.turn_on
    entity_id: group.woonkamer_lights

- id: ikea_dimmer_waarde
  alias: Dimmer waarde
  trigger:
    platform: mqtt
    topic: 'zigbee2mqtt/ikea_dimmer'
  action:
    service: light.turn_on
    data:
      entity_id:
        - light.ikea_lamp_1_light
        - light.ikea_lamp_2_light
        - light.ikea_lamp_3_light
    data_template:
      brightness: '{{ states.sensor["ikea_dimmer"].state | int }}'

- id: deur_op_slot
  alias: Deur op slot
  hide_entity: true
  trigger:
    - platform: state
      entity_id: binary_sensor.deur
      from: 'off'
      to: 'on'
  action:
    service: notify.slack
    data_template:
      message: >
        Deur op slot
      target: "@rob"

- id: deur_van_slot
  alias: Deur van slot
  hide_entity: true
  trigger:
    - platform: state
      entity_id: binary_sensor.deur
      from: 'on'
      to: 'off'
  action:
    service: notify.slack
    data_template:
      message: >
        Deur van slot
      target: "@rob"

- id: mqtt_channel_check
  alias: Mqtt channel check
  trigger:
  - at: '20:00:00'
    platform: time
  condition:
    condition: or
    conditions:
      - condition: numeric_state
        entity_id: 'sensor.co2_woonkamer_lastupdate'
        above: 30
      - condition: numeric_state
        entity_id: 'sensor.co2_slaapkamer_lastupdate'
        above: 30
      - condition: numeric_state
        entity_id: 'sensor.co2_studeerkamer_lastupdate'
        above: 30
      - condition: numeric_state
        entity_id: 'sensor.watermeter_lastupdate'
        above: 720
      - condition: numeric_state
        entity_id: 'sensor.ventilator_snelheid_lastupdate'
        above: 720
      - condition: numeric_state
        entity_id: 'sensor.weerstation_temperatuur_lastupdate'
        above: 720
  action:
    service: notify.slack
    data_template:
      message: >
        Een van de Mqtt services is down. Laatste updates: 
        Co2 woonkamer: {{ states.sensor.co2_woonkamer_lastupdate.state }}, 
        Co2 slaapkamer: {{ states.sensor.co2_slaapkamer_lastupdate.state }}, 
        Co2 studeerkamer: {{ states.sensor.co2_studeerkamer_lastupdate.state }}, 
        Watermeter: {{ states.sensor.watermeter_lastupdate.state }},
        Ventilator: {{ states.sensor.ventilator_snelheid_lastupdate.state }},
        Weerstation: {{ states.sensor.weerstation_temperatuur_lastupdate.state }}.
      target: "@rob"

- id: ventilator_aan
  alias: Ventilator aan
  trigger:
    platform: time_pattern
    minutes: '/10'
    seconds: 00
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: 'fan.ventilatiesysteem'
        state: 'off'
      - condition: or
        conditions:
          - condition: numeric_state
            entity_id: 'sensor.slaapkamer_mh_z19_co2_waarde'
            above: '600'
          - condition: numeric_state
            entity_id: 'sensor.studeerkamer_mh_z19_co2_waarde'
            above: '600'
          - condition: numeric_state
            entity_id: 'sensor.woonkamer_mh_z19_co2_waarde'
            above: '600'
  action:
    - service: fan.turn_on
      entity_id: fan.ventilatiesysteem

- id: ventilator_uit
  alias: Ventilator uit
  trigger:
    platform: time_pattern
    minutes: '/10'
    seconds: 00
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: 'fan.ventilatiesysteem'
        state: 'on'
      - condition: numeric_state
        entity_id: 'sensor.slaapkamer_mh_z19_co2_waarde'
        below: '600'
      - condition: numeric_state
        entity_id: 'sensor.studeerkamer_mh_z19_co2_waarde'
        below: '600'
      - condition: numeric_state
        entity_id: 'sensor.woonkamer_mh_z19_co2_waarde'
        below: '600'
  action:
    - service: fan.turn_off
      entity_id: fan.ventilatiesysteem
